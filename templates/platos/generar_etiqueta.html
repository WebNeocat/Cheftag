{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Card del formulario -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Generar Etiqueta de Plato</h4>
        </div>
        <div class="card-body">
            <form method="post" class="row g-3">
                {% csrf_token %}
                {% for field in form %}
                    <div class="col-md-4">
                        <label class="form-label fw-bold">{{ field.label }}</label>
                        {{ field }}
                    </div>
                {% endfor %}

                <div class="col-md-2">
                    <label class="form-label fw-bold">Cantidad Platos</label>
                    <input type="number" name="cantidad" class="form-control" value="1" min="1" required>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-inverse-success w-100">
                        <i class="bi bi-plus-circle"></i> Generar Etiqueta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de etiquetas -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Etiquetas generadas</h4>
        </div>
        <div class="card-body p-0">
            {% if etiquetas %}
                <form id="form-etiquetas" method="post" action="{% url 'platos:generar_etiqueta' %}">
                    {% csrf_token %}
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>Plato</th>
                                <th>Peso</th>
                                <th>Lote</th>
                                <th>Caducidad</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in etiquetas %}
                            <tr>
                                <td><input type="checkbox" name="etiquetas" value="{{ e.id }}"></td>
                                <td>{{ e.plato.nombre }}</td>
                                <td>{{ e.peso }} g</td>
                                <td>{{ e.lote }}</td>
                                <td>{{ e.caducidad|date:"d/m/Y" }}</td>
                                <td>
                                    {% if e.impresa %}
                                        <span class="badge bg-success">Impreso</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Botones de acción -->
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" id="btn-imprimir" name="accion" value="imprimir" class="btn btn-success w-50">
                            <i class="bi bi-printer"></i> Imprimir seleccionadas
                        </button>

                        <!-- Cambiado a botón tipo "button" para abrir modal -->
                        <button type="button" id="btn-eliminar" class="btn btn-danger w-50">
                            <i class="bi bi-trash"></i> Eliminar seleccionadas
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="p-3 text-muted text-center">
                    No hay etiquetas generadas todavía.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="confirmEliminarModal" tabindex="-1" aria-labelledby="confirmEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmEliminarLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Eliminar las etiquetas seleccionadas?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="confirmarEliminar" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Advertencia Selección -->
<div class="modal fade" id="modalAdvertencia" tabindex="-1" aria-labelledby="modalAdvertenciaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="modalAdvertenciaLabel">Advertencia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ⚠️ Debes seleccionar al menos una etiqueta para continuar.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
document.getElementById("select-all").addEventListener("click", function(e) {
    document.querySelectorAll("input[name='etiquetas']").forEach(cb => cb.checked = e.target.checked);
});

document.getElementById("btn-imprimir").addEventListener("click", function(e) {
    const form = document.getElementById("form-etiquetas");
    const checkboxes = form.querySelectorAll("input[name='etiquetas']:checked");

    if (checkboxes.length === 0) {
        e.preventDefault();
        // Mostrar modal advertencia en vez de alert
        const modalAdvertencia = new bootstrap.Modal(document.getElementById('modalAdvertencia'));
        modalAdvertencia.show();
        return;
    }

    // Abrir en pestaña nueva
    form.target = "_blank";

    // Recargar página después de 1 segundo
    setTimeout(() => {
        window.location.reload();
    }, 1000);
});

// Al pulsar botón Eliminar, validar selección y abrir modal confirmación
document.getElementById("btn-eliminar").addEventListener("click", function(e) {
    const form = document.getElementById("form-etiquetas");
    const checkboxes = form.querySelectorAll("input[name='etiquetas']:checked");

    if (checkboxes.length === 0) {
        // Mostrar modal advertencia
        const modalAdvertencia = new bootstrap.Modal(document.getElementById('modalAdvertencia'));
        modalAdvertencia.show();
        return;
    }

    // Mostrar modal confirmación eliminación
    const modalConfirm = new bootstrap.Modal(document.getElementById('confirmEliminarModal'));
    modalConfirm.show();
});

// Confirmar eliminación: se añade campo acción y se envía formulario
document.getElementById("confirmarEliminar").addEventListener("click", function() {
    const form = document.getElementById("form-etiquetas");

    // Crear o actualizar input hidden para la acción eliminar
    let inputAccion = form.querySelector("input[name='accion']");
    if (!inputAccion) {
        inputAccion = document.createElement('input');
        inputAccion.type = 'hidden';
        inputAccion.name = 'accion';
        form.appendChild(inputAccion);
    }
    inputAccion.value = 'eliminar';

    form.submit();
});
</script>
{% endblock %}





