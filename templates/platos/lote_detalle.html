<div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header bg-primary">
            <h2 class="modal-title text-white">Detalle del Lote: {{ raciones.0.lote_agrupado }}</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="form-reimprimir" method="post" action="{% url 'platos:reimprimir_etiquetas' %}">
                {% csrf_token %}
                <div class="table-wrapper">
                    <table class="table table-hover tabla-responsive align-middle" style="table-layout: auto; width: 100%;">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 5%;">
                                    <input type="checkbox" id="seleccionar-todo">
                                </th>
                                <th style="width: 15%;">Fecha</th>
                                <th style="width: 20%;">Lote</th>
                                <th style="width: 30%;">Plato</th>
                                <th style="width: 10%;">Turno</th>
                                <th style="width: 15%;">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for racion in raciones %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="etiquetas" value="{{ racion.id }}">
                                </td>
                                <td>{{ racion.fecha|date:"d/m/Y H:i" }}</td>
                                <td>{{ racion.lote }}</td>
                                <td title="{{ racion.plato.nombre }}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    {{ racion.plato.nombre|truncatewords:5 }}
                                </td>
                                <td>{{ racion.turno }}</td>
                                <td>{{ racion.peso|floatformat:2 }} g</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">⚠️ No hay raciones para este lote.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Botones para imprimir y eliminar -->
                <div class="d-flex gap-2 mt-3 justify-content-end">
                    <button type="submit" name="accion" value="imprimir" class="btn btn-success">
                        <i class="fa fa-print"></i> Reimprimir
                    </button>

                    <!-- Botón para eliminar, ahora tipo button para abrir modal -->
                    <button type="button" id="btn-eliminar" class="btn btn-danger">
                        <i class="fa fa-trash"></i> Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="confirmEliminarModal" tabindex="-1" aria-labelledby="confirmEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmEliminarLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Eliminar las etiquetas seleccionadas?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="confirmarEliminar" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script>
    // Seleccionar / deseleccionar todas las checkboxes
    document.getElementById('seleccionar-todo').addEventListener('change', function() {
        const checked = this.checked;
        document.querySelectorAll("input[name='etiquetas']").forEach(cb => cb.checked = checked);
    });

    // Validar selección y controlar target del formulario
    document.getElementById('form-reimprimir').addEventListener('submit', function(e) {
        const seleccionados = document.querySelectorAll("input[name='etiquetas']:checked");
        if (seleccionados.length === 0) {
            e.preventDefault();
            alert("⚠️ Debes seleccionar al menos una etiqueta para continuar.");
            return;
        }

        if (e.submitter && e.submitter.name === 'accion' && e.submitter.value === 'imprimir') {
            // Para imprimir, abrir en nueva pestaña
            this.target = '_blank';
            // Recarga la página tras imprimir para actualizar listado
            setTimeout(() => location.reload(), 1500);
        } else {
            // Para eliminar, abrir en misma pestaña
            this.target = '_self';
        }
    });

    // Abrir modal de confirmación al hacer clic en eliminar
    document.getElementById('btn-eliminar').addEventListener('click', function() {
        const seleccionados = document.querySelectorAll("input[name='etiquetas']:checked");
        if (seleccionados.length === 0) {
            alert("⚠️ Debes seleccionar al menos una etiqueta para continuar.");
            return;
        }
        const eliminarModal = new bootstrap.Modal(document.getElementById('confirmEliminarModal'));
        eliminarModal.show();
    });

    // Confirmar eliminación y enviar formulario con acción eliminar
    document.getElementById('confirmarEliminar').addEventListener('click', function() {
        const form = document.getElementById('form-reimprimir');

        // Crear o actualizar el input hidden para la acción eliminar
        let inputAccion = form.querySelector("input[name='accion']");
        if (!inputAccion) {
            inputAccion = document.createElement('input');
            inputAccion.type = 'hidden';
            inputAccion.name = 'accion';
            form.appendChild(inputAccion);
        }
        inputAccion.value = 'eliminar';

        form.submit();
    });

    // Cerrar modal y eliminar backdrop (si usas Bootstrap 5)
    document.querySelectorAll('.modal .btn-close, .modal .btn-secondary').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal');
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) modalInstance.hide();
                document.querySelector('.modal-backdrop')?.remove();
            }
        });
    });
</script>




