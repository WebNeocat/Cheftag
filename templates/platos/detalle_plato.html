<div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
        <div class="modal-header bg-info">
            <h2 class="modal-title text-white">Editar Plato</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            </button>
        </div>
        <div class="modal-body">
            <div class="container">
                <form method="post" action="{% url 'platos:PlatoUpdate' plato.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="card mb-3">
                        <div class="card-header bg-inverse-info">Datos del Plato</div>
                        <div class="card-body">
                            {{ form.as_p }}
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-inverse-info">Ingredientes</div>
                        <div class="card-body">
                            {{ ingredientes_formset.management_form }}
                            
                            <div id="ingredientes-formset">
                                {% for form in ingredientes_formset %}
                                    <div class="ingrediente-form mb-3 p-2 border rounded" style="border-color: #808b96 !important;">
                                    {{ form.as_p }}
                                    {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <button type="button" id="add-more" class="btn btn-secondary mt-2">
                                <i class="fa fa-plus"></i> &nbsp;Añadir Ingrediente
                            </button>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="fa fa-save"></i>&nbsp;Guardar
                                </button>
                                <a href="{% url 'platos:PlatoList' %}" class="btn btn-danger">
                                    <i class="fa fa-times"></i>&nbsp;Cancelar
                                </a>
                            </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<style>
  #ingredientes-formset {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .ingrediente-form {
    flex: 0 0 calc(50% - 5px); /* 2 columnas con 10px gap */
  }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Clona el último formulario del formset al hacer clic en "Añadir otro"
    document.getElementById('add-more').addEventListener('click', function() {
        const formset = document.getElementById('ingredientes-formset');
        const forms = formset.querySelectorAll('.ingrediente-form');
        const lastForm = forms[forms.length - 1];
        const newForm = lastForm.cloneNode(true);
        newForm.classList.add('col-md-6');
        
        // Limpia los valores del nuevo formulario
        const inputs = newForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.name) {
                const name = input.name.replace(/-\d+-/, `-${forms.length}-`);
                input.name = name;
                input.id = `id_${name}`;
                input.value = '';
            }
        });
        
        // Limpia los errores de validación
        const errorList = newForm.querySelectorAll('.errorlist');
        errorList.forEach(el => el.remove());
        
        formset.appendChild(newForm);
        
        // Actualiza el contador TOTAL_FORMS
        const totalForms = document.getElementById('id_ingredientes-TOTAL_FORMS');
        totalForms.value = forms.length + 1;
    });
});
</script>
<script>
    // Agrega un evento de clic a los botones de cerrar y cancelar
    $('.modal .close, .modal .btn-danger').click(function() {
        // Oculta el modal
        $('.modal').modal('hide');
        // Elimina el fondo oscuro
        $('.modal-backdrop').remove();
    });
</script>