{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="content-wrapper">
    <div class="card shadow-lg border-0 rounded-lg overflow-hidden">
        <!-- Cabecera mejorada -->
        <div class="card-header bg-gradient-primary text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="m-0"><i class="fa fa-list me-2"></i>Receta: {{ receta.plato.nombre }}</h3>
                    <small class="text-white-50">Detalles completos de la preparación</small>
                </div>
                <div>
                    <a href="{% url 'platos:PlatoList' %}" class="btn btn-light btn-sm me-2 rounded" title="Volver al listado">
                        <i class="fa fa-arrow-left me-1"></i> Volver
                    </a>
                    <a href="{% url 'platos:editar_receta' receta.pk %}" class="btn btn-light btn-sm rounded shadow-sm">
                        <i class="fa fa-edit me-1"></i> Editar Receta
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card-body p-4">
            <!-- Información básica - Tarjetas mejoradas -->
            <div class="row mb-4 g-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0 pb-0">
                            <h5 class="card-title mb-0 text-primary">
                                <i class="fa fa-clock me-2"></i>Tiempos
                            </h5>
                        </div>
                        <div class="card-body pt-0">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span><strong>Preparación:</strong></span>
                                    <span class="badge bg-primary rounded-pill">{{ receta.tiempo_preparacion }} min</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span><strong>Cocción:</strong></span>
                                    <span class="badge bg-primary rounded-pill">{{ receta.tiempo_coccion }} min</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-inverse-info rounded px-1">
                                    <span class="fw-bold">Total:</span>
                                    <span class="badge bg-success rounded-pill">{{ tiempo_total }} min</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <div class="mb-3">
                                <i class="fa fa-utensil-spoon fa-3x text-primary opacity-25"></i>
                            </div>
                            <h2 class="display-4 text-primary mb-1">{{ receta.rendimiento }}</h2>
                            <p class="text-muted mb-0">PORCIONES</p>
                            <small class="text-muted mt-2">
                                <i class="fa fa-info-circle me-1"></i>Ajusta cantidades según necesidades
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm overflow-hidden">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="card-title mb-0 text-primary">
                                <i class="fa fa-drumstick-bite me-2"></i>Plato Asociado
                            </h5>
                        </div>
                        <div class="card-body text-center p-0 d-flex flex-column">
                            {% if receta.plato.imagen %}
                                <div class="flex-grow-1 d-flex align-items-center justify-content-center p-3">
                                    <img src="{{ receta.plato.imagen.url }}" 
                                         class="img-fluid rounded shadow" 
                                         style="max-height: 120px; object-fit: cover;" 
                                         alt="{{ receta.plato.nombre }}">
                                </div>
                            {% else %}
                                <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-light">
                                    <i class="fa fa-image fa-4x text-muted opacity-25"></i>
                                </div>
                            {% endif %}
                            <div class="p-3 border-top">
                                <h5 class="mb-0">{{ receta.plato.nombre }}</h5>
                                {% if receta.plato.tipoplato %}
                                    <span class="badge bg-info mt-1">{{ receta.plato.tipoplato }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ingredientes - Tabla mejorada -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-inverse-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="m-0"><i class="fa fa-cutlery me-2"></i>Ingredientes</h4>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <span class="input-group-text bg-white">Porciones</span>
                                <input type="number" id="porciones-input" 
                                    class="form-control" 
                                    min="0.1" 
                                    step="0.1"
                                    value="{{ receta.rendimiento }}"
                                    style="text-align: center;">
                            </div>
                            <span class="badge bg-primary ms-2" id="ingredientes-count">
                                {{ ingredientes|length }} items
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ingrediente</th>
                                    <th>Cantidad</th>
                                    <th>Unidad</th>
                                    <th class="text-end">Para <span id="porciones-actuales">{{ receta.rendimiento }}</span> porciones</th>
                                </tr>
                            </thead>
                            <tbody id="ingredientes-body">
                                {% for ingrediente in ingredientes %}
                                <tr data-cantidad-base="{{ ingrediente.cantidad|stringformat:"f" }}">
                                    <td>{{ ingrediente.alimento.nombre }}</td>
                                    <td class="cantidad-ingrediente">{{ ingrediente.cantidad|floatformat:"g" }}</td>
                                    <td>{{ ingrediente.unidad_medida.abreviatura }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-inverse-warning text-dark">
                                            {{ ingrediente.cantidad|floatformat:"g" }} {{ ingrediente.unidad_medida.abreviatura }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No hay ingredientes registrados</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Instrucciones - Sección mejorada -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-inverse-primary text-white py-3">
                    <h4 class="m-0"><i class="fa fa-list-ol me-2"></i>Instrucciones de Preparación</h4>
                </div>
                <div class="card-body">
                    <div class="p-3 bg-light rounded">
                        {% if receta.instrucciones %}
                            <div class="recipe-steps">
                                {{ receta.instrucciones|linebreaks }}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fa fa-info-circle fa-2x mb-3"></i>
                                <p class="mb-0">No se han agregado instrucciones para esta receta</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-inverse-info border-0 d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fa fa-clock-o me-1"></i> Última actualización: {{ receta.updated_at|date:"d/m/Y H:i" }}
                    </small>
                    <button class="btn btn-sm btn-danger rounded" onclick="imprimirReceta()">
                        <i class="fa fa-print me-1"></i> Imprimir Receta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card-header.bg-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    }
    .card-header.bg-gradient-secondary {
        background: linear-gradient(135deg, #858796 0%, #60616f 100%);
    }
    .card-header.bg-gradient-info {
        background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
    }
    .recipe-steps {
        counter-reset: step-counter;
    }
    .recipe-steps p {
        position: relative;
        padding-left: 2.5rem;
        margin-bottom: 1rem;
        counter-increment: step-counter;
    }
    .recipe-steps p:before {
        content: counter(step-counter);
        position: absolute;
        left: 0;
        top: 0;
        background: #4e73df;
        color: white;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: bold;
    }
        #porciones-input {
        font-weight: bold;
        color: #2c3e50;
    }
    
    #porciones-input:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
    }
    
    .cantidad-ingrediente {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .badge.bg-light {
        border: 1px solid #dee2e6;
        background: green;
    }
</style>
{% endblock %}
{% block extrajs %}
<script>
    // Función para calcular ingredientes según porciones
    function calcularIngredientes() {
        // Obtener valor como float y asegurar mínimo 0.1
        let porcionesDeseadas = parseFloat(document.getElementById('porciones-input').value);
        if (isNaN(porcionesDeseadas) || porcionesDeseadas <= 0) {
            porcionesDeseadas = 1;
            document.getElementById('porciones-input').value = 1;
        }

        const porcionesBase = parseFloat({{ receta.rendimiento }});
        const factor = porcionesDeseadas / porcionesBase;
        
        // Mostrar porciones actuales con formato
        document.getElementById('porciones-actuales').textContent = formatNumber(porcionesDeseadas);
        
        // Calcular y formatear cada ingrediente
        document.querySelectorAll('#ingredientes-body tr[data-cantidad-base]').forEach(row => {
            const cantidadBase = parseFloat(row.getAttribute('data-cantidad-base'));
            const cantidadCalculada = cantidadBase * factor;
            const unidad = row.querySelector('td:nth-child(3)').textContent;
            
            row.querySelector('.cantidad-ingrediente').textContent = formatNumber(cantidadCalculada);
            row.querySelector('td:last-child .badge').textContent = 
                `${formatNumber(cantidadCalculada)} ${unidad}`;
        });
    }

    // Función de formato mejorada para todos los casos
    function formatNumber(num) {
        if (isNaN(num)) return "0";

        // Redondear a 3 decimales
        num = Math.round(num * 1000) / 1000;

        // Ver si tiene decimales significativos
        if (Number.isInteger(num)) {
            return num.toString();  // sin coma si es entero
        }

        // Convertir a string con máximo 3 decimales significativos
        return num.toString().replace('.', ',').replace(/,?0+$/, '');
    }

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Establecer valor inicial con decimales si es necesario
        const porcionesBase = parseFloat({{ receta.rendimiento }});
        document.getElementById('porciones-input').value = porcionesBase % 1 === 0 ? porcionesBase : porcionesBase.toFixed(1);
        
        calcularIngredientes();
    });

    // Event listener para cambios
    document.getElementById('porciones-input').addEventListener('input', calcularIngredientes);
    
    // Función de impresión
    function imprimirReceta() {
        // Clonar el contenido de la receta
        const contenidoOriginal = document.querySelector('.content-wrapper').innerHTML;
        const ventanaImpresion = window.open('', '', 'width=800,height=600');
        
        // Obtener el texto de instrucciones sin HTML
        const instruccionesTexto = document.querySelector('.recipe-steps').innerText;
        // Estilos para impresión (mejor legibilidad)
        ventanaImpresion.document.write(`
            <html>
                <head>
                    <title>Receta: {{ receta.plato.nombre }}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        .no-print { display: none !important; }
                        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background: #f5f5f5; text-align: left; }
                        th, td { padding: 8px; border: 1px solid #ddd; }
                        .instrucciones { white-space: pre-line; margin-top: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .footer { margin-top: 30px; font-size: 12px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Receta: {{ receta.plato.nombre }}</h1>
                        {% if receta.plato.imagen %}
                            <img src="{{ receta.plato.imagen.url }}" style="max-height: 100px;">
                        {% endif %}
                    </div>
                    
                    <div class="info-basica">
                        <p><strong>Tiempo total:</strong> {{ tiempo_total }} minutos</p>
                        <p><strong>Porciones:</strong> {{ receta.rendimiento }}</p>
                    </div>
                    
                    <h3>Ingredientes</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Ingrediente</th>
                                <th>Cantidad</th>
                                <th>Unidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ingrediente in ingredientes %}
                            <tr>
                                <td>{{ ingrediente.alimento.nombre }}</td>
                                <td>{{ ingrediente.cantidad }}</td>
                                <td>{{ ingrediente.unidad_medida.abreviatura }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <h3>Instrucciones</h3>
                    <div class="instrucciones">${instruccionesTexto}</div>
                    
                    <div class="footer">
                        <p>Receta generada el {% now "d/m/Y" %}</p>
                    </div>
                </body>
            </html>
        `);
        
        ventanaImpresion.document.close();
        ventanaImpresion.focus();
        setTimeout(() => {
            ventanaImpresion.print();
            ventanaImpresion.close();
        }, 500);
    }
</script>
{% endblock %}